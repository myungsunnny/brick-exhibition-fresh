<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대불초등학교 브릭모델 전시관</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            position: relative;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header-logo {
            max-height: 2.5rem; 
            margin-right: 15px;
            vertical-align: middle;
        }
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        .header-buttons {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .header-btn.active {
            background: rgba(255,255,255,0.4);
            font-weight: bold;
        }
        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }
        .panel.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-panel {
            padding: 30px;
        }
        .admin-panel {
            padding: 30px;
        }
        .status-section {
            padding: 20px;
        }
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            flex-wrap: wrap;
        }
        .admin-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .admin-tab:hover {
            background: #e9ecef;
        }
        .admin-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .admin-content {
            display: none;
        }
        .admin-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group .sub-label {
            font-weight: normal;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .image-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .image-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        .image-upload input {
            display: none;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
        }
        .upload-progress {
            margin-top: 10px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        .upload-progress-bar {
            height: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
        }
        .btn-secondary:hover {
            background: #e9ecef;
        }
        .btn-small {
            padding: 5px 15px;
            font-size: 0.8rem;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        .type-heading {
            grid-column: 1 / -1;
            color: white;
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
            margin-top: 30px;
            margin-bottom: 10px;
        }
        .type-heading:first-child {
            margin-top: 0;
        }
        .artwork-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .artwork-image {
            width: 100%;
            height: 250px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: zoom-in;
        }
        .artwork-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .artwork-image .placeholder {
            font-size: 3rem;
            color: #999;
        }
        .artwork-info {
            padding: 20px;
        }
        .artwork-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .artwork-author {
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .artwork-description {
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }
        .artwork-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .like-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        .like-btn:hover, .like-btn.liked {
            color: #e74c3c;
        }
        .admin-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 5px;
            z-index: 5;
        }
        .admin-mode .admin-controls {
            display: flex;
        }
        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .comment {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
        }
        .comment-author {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .comment-text {
            line-height: 1.6;
            color: #555;
            margin-bottom: 10px;
        }
        .comment-date {
            font-size: 0.8rem;
            color: #999;
        }
        .comment-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 5px;
        }
        .admin-mode .comment-controls {
            display: flex;
        }
        .comment-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .replies-container {
            margin-left: 40px;
            margin-top: 15px;
            border-left: 2px solid #eee;
            padding-left: 15px;
        }
        .reply {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid #eee;
        }
        .reply-form {
            margin-left: 40px;
            padding: 15px;
            background: #f1f2f6;
            border-radius: 10px;
            margin-top: 10px;
            display: none;
        }
        .btn-reply {
            font-size: 0.8rem;
            padding: 2px 8px;
            margin-left: 10px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background: #f8f9fa;
        }
        #artworksTableBody tr {
            cursor: grab;
        }
        #artworksTableBody tr.dragging {
            opacity: 0.5;
            background: #e9ecef;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin: 5px;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .grade-info-section {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
            transition: all 0.3s ease;
            display: none;
        }
        .grade-info-section.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        .grade-info-content h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .grade-info-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        .grade-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .grade-stat {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }
        .grade-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .grade-stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .search-container {
            margin-bottom: 30px;
            text-align: center;
        }
        .search-container input {
            padding: 12px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            backdrop-filter: blur(10px);
            font-size: 1rem;
            width: 300px;
            text-align: center;
        }
        .search-container input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .filters-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .filters {
            display: flex;
            gap: 10px; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .filter-btn:hover, .filter-btn.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        .close-btn:hover {
            color: #333;
        }
        .edit-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .bulk-actions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .settings-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .checkbox-group {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .checkbox-group:hover {
            border-color: #667eea;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            flex-shrink: 0;
        }
        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 30px 0;
        }
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        .fullscreen-overlay.show {
            display: flex;
        }
        .fullscreen-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
        }
        .fullscreen-close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 3rem;
            color: white;
            cursor: pointer;
        }
        .modal-image-gallery {
            text-align: center;
            margin-bottom: 20px;
        }
        .modal-main-image {
            max-width: 100%;
            max-height: 450px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: zoom-in;
            background: #f0f0f0;
        }
        .modal-thumbnails {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .modal-thumbnail-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        .modal-thumbnail-img:hover {
            border-color: #ddd;
        }
        .modal-thumbnail-img.active {
            border-color: #667eea;
        }
        @media (max-width: 768px) {
            h1 { font-size: 2rem; flex-wrap: wrap; }
            .header-logo { max-height: 2rem; }
            .container { padding: 15px; }
            .gallery { grid-template-columns: 1fr; }
            .header-buttons { 
                position: static; 
                justify-content: center; 
                margin-top: 20px;
            }
            .search-container input { width: 100%; max-width: 300px; }
            .admin-tabs { justify-content: center; }
            .stats-grid { grid-template-columns: 1fr; }
            .settings-options-grid { grid-template-columns: 1fr; }
            .filters-container { padding: 0 15px; }
            .filters { padding: 12px 20px; gap: 8px; flex-wrap: wrap; justify-content: center; border-radius: 20px; }
            .filter-btn { padding: 6px 12px; font-size: 0.8rem; min-width: 55px; border-radius: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-buttons">
                <button class="header-btn" onclick="toggleUploadPanel()">✏️ 작품 올리기</button>
                <button class="header-btn" onclick="toggleAdminPanel()">⚙️ 관리자 모드</button>
            </div>
            <h1>
                <img src="" alt="헤더 로고" id="headerImage" class="header-logo" style="display: none;">
                <span id="headerTitleText">대불초등학교 브릭모델 전시관</span>
            </h1>
            <p class="subtitle">창의적인 브릭모델 활동으로 만든 멋진 작품들을 만나보세요</p>
        </header>

        <div class="panel status-section" id="statusSection">
            </div>

        <div class="panel upload-panel" id="uploadPanel">
            </div>

        <div class="panel admin-panel" id="adminPanel">
            </div>

        <div class="filters-container">
            <div class="filters">
                <button class="filter-btn active" data-category="all">전체 학년</button>
                <button class="filter-btn" data-category="1학년">1학년</button>
                <button class="filter-btn" data-category="2학년">2학년</button>
                <button class="filter-btn" data-category="3학년">3학년</button>
                <button class="filter-btn" data-category="4학년">4학년</button>
                <button class="filter-btn" data-category="5학년">5학년</button>
                <button class="filter-btn" data-category="6학년">6학년</button>
            </div>
        </div>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="작품명 또는 이름(모둠)으로 검색...">
        </div>

        <div class="grade-info-section" id="gradeInfoSection">
        </div>

        <div class="gallery" id="gallery">
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreenImage()">
        <span class="fullscreen-close-btn">&times;</span>
        <img src="" alt="Fullscreen Image" class="fullscreen-image" id="fullscreenImage">
    </div>

    <script>
        const CLOUDINARY_CLOUD_NAME = 'dc0hyzldx';
        const CLOUDINARY_UPLOAD_PRESET = 'daebul_fresh';
        let artworks = [];
        let comments = {};
        let likes = {};
        let likedArtworks = new Set();
        let settings = {};
        const defaultSettings = {
            title: '대불초등학교 브릭모델 전시관',
            headerImage: '',
            description: '창의적인 브릭모델 활동으로 만든 멋진 작품들을 만나보세요',
            allowComments: true,
            moderateComments: false,
            adminPassword: '1234',
            requireUploadPassword: false, 
            uploadPassword: '0000',      
            gradeDescriptions: {
                'all': { title: '🧱 모든 학년 브릭모델 작품', description: '대불초등학교 학생들의 창의적인 브릭모델 작품들을 만나보세요. 각 학년별로 다양한 주제와 스타일의 작품들이 전시되어 있습니다.' },
                '1학년': { title: '🌟 1학년 브릭모델 작품', description: '1학년 친구들의 첫 번째 브릭모델 작품들입니다. 기본적인 블록 쌓기부터 시작하여 간단한 집, 동물, 자동차 등을 만들며 창의력과 손재주를 기르고 있어요!' },
                '2학년': { title: '🎨 2학년 브릭모델 작품', description: '2학년 친구들은 더욱 정교한 작품을 만들 수 있게 되었어요. 색깔 조합과 기본 구조를 이해하며 자신만의 개성이 담긴 작품들을 선보입니다.' },
                '3학년': { title: '🏗️ 3학년 브릭모델 작품', description: '3학년이 되면서 더욱 복잡한 구조물을 만들 수 있게 되었어요. 건축물의 기본 원리를 이해하고 계획적으로 작품을 제작하는 능력이 늘어났습니다.' },
                '4학년': { title: '🚀 4학년 브릭모델 작품', description: '4학년 친구들은 테마가 있는 작품들을 만들기 시작했어요. 과학적 사고와 창의적 아이디어를 결합하여 미래 도시, 우주선 등 상상력이 풍부한 작품들을 제작합니다.' },
                '5학년': { title: '🎯 5학년 브릭모델 작품', description: '5학년 작품들은 한층 더 정교하고 완성도가 높아졌어요. 기능적인 요소들을 고려하며 실용적이면서도 아름다운 작품들을 만들어 냅니다.' },
                '6학년': { title: '🏆 6학년 브릭모델 작품', description: '6학년 친구들의 작품은 정말 놀라워요! 수년간 쌓은 경험과 실력으로 복잡한 메커니즘, 대형 구조물, 정교한 디테일을 가진 작품들을 완성합니다.' }
            }
        };
        let isAdminMode = false;
        let isSaving = false;

        async function loadDataFromDB() { try { const response = await fetch('/api/data'); if (!response.ok) throw new Error(`Server response error: ${response.status}`); const data = await response.json(); artworks = data.artworks || []; comments = data.comments || {}; likes = data.likes || {}; settings = data.settings ? { ...defaultSettings, ...data.settings } : defaultSettings; document.getElementById('upstashStatus').innerHTML = '<span class="status-indicator status-success">✅ 데이터베이스 연결됨</span>'; return true; } catch (error) { console.error('Data loading failure:', error); document.getElementById('upstashStatus').innerHTML = `<span class="status-indicator status-error">❌ DB 연결 실패</span>`; showMessage('데이터베이스에서 정보를 가져오는 데 실패했습니다. 페이지를 새로고침 해주세요.', 'error'); return false; } }
        async function saveDataToDB() { if (isSaving) { console.warn("A save operation is already in progress."); return false; } isSaving = true; try { const response = await fetch('/api/data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ artworks, comments, likes, settings }) }); if (!response.ok) throw new Error(`Server response error: ${response.status}`); console.log('✅ Data successfully saved to DB.'); return true; } catch (error) { console.error('Data saving failure:', error); showMessage('데이터를 데이터베이스에 저장하는 데 실패했습니다.', 'error'); return false; } finally { isSaving = false; } }
        function loadLikedFromLocal() { const liked = localStorage.getItem('likedArtworks'); likedArtworks = liked ? new Set(JSON.parse(liked)) : new Set(); }
        function saveLikedToLocal() { localStorage.setItem('likedArtworks', JSON.stringify([...likedArtworks])); }
        
        document.addEventListener('DOMContentLoaded', async function() { 
            console.log('🧱 브릭모델 전시관 로드'); 
            loadLikedFromLocal(); 
            if (await loadDataFromDB()) { 
                applyHeaderSettings(); 
                renderGroupedGallery(); 
                updateGradeInfo('all'); 
                setupDragAndDrop(); 
            } else { 
                const gallery = document.getElementById('gallery'); 
                gallery.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: white; padding: 50px;"><h3>데이터 로딩 실패</h3><p>페이지를 새로고침하거나 관리자에게 문의하세요. 😥</p></div>`; 
            } 
            document.getElementById('cloudinaryStatus').innerHTML = '<span class="status-indicator status-success">✅ Cloudinary 연결됨</span>'; 
            console.log('✅ 초기화 완료'); 
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateGradeInfo(btn.dataset.category);
                renderGroupedGallery();
            });
        });

        document.getElementById('searchInput').addEventListener('input', renderGroupedGallery);
        
        function renderGroupedGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            const activeGrade = document.querySelector('.filter-btn.active').dataset.category;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filteredArtworks = artworks;

            if (activeGrade !== 'all') {
                filteredArtworks = filteredArtworks.filter(artwork => artwork.grade === activeGrade);
            }

            if (searchTerm) {
                filteredArtworks = filteredArtworks.filter(artwork => 
                    artwork.title.toLowerCase().includes(searchTerm) || 
                    artwork.author.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredArtworks.length === 0) {
                gallery.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: white; padding: 50px;"><h3>해당하는 작품이 없습니다.</h3></div>`;
                return;
            }

            const artworkTypes = ['사진', '결과물', '학습지(활동지)'];
            let contentAdded = false;

            artworkTypes.forEach(type => {
                const worksOfType = filteredArtworks.filter(artwork => (artwork.artworkType || '사진') === type);
                
                if (worksOfType.length > 0) {
                    contentAdded = true;
                    const heading = document.createElement('h2');
                    heading.className = 'type-heading';
                    heading.textContent = `📷 ${type}`;
                    gallery.appendChild(heading);

                    worksOfType.forEach(artwork => {
                        const card = createArtworkCard(artwork);
                        gallery.appendChild(card);
                    });
                }
            });

            if (!contentAdded) {
                gallery.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: white; padding: 50px;"><h3>해당하는 작품이 없습니다.</h3></div>`;
            }
        }
        
        function createArtworkCard(artwork) {
            const card = document.createElement('div');
            card.className = 'artwork-card';
            const isLiked = likedArtworks.has(artwork.id);
            const likeCount = likes[artwork.id] || 0;
            const artworkComments = comments[artwork.id] || [];
            const mainImage = (artwork.images && artwork.images.length > 0) ? artwork.images[0] : '';
            card.innerHTML = `<div class="admin-controls"><button class="btn-warning" onclick="event.stopPropagation(); editArtwork('${artwork.id}')">수정</button><button class="btn-danger" onclick="event.stopPropagation(); deleteArtwork('${artwork.id}')">삭제</button></div><div class="artwork-image" onclick="event.stopPropagation(); showFullscreenImage('${mainImage}')">${mainImage ? `<img src="${mainImage}" alt="${artwork.title}" loading="lazy">` : '<div class="placeholder">🧱</div>'}</div><div class="artwork-info"><h3 class="artwork-title">${artwork.title}</h3><p class="artwork-author">${artwork.author} (${artwork.grade})</p><p class="artwork-description">${artwork.description}</p><div class="artwork-stats"><button class="like-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLike('${artwork.id}')">❤️ ${likeCount}</button><span>💬 ${artworkComments.length}</span></div></div>`;
            card.addEventListener('click', () => showArtworkModal(artwork));
            return card;
        }

        document.getElementById('artworkForm').addEventListener('submit', async function(e) { e.preventDefault(); const submitBtn = document.getElementById('submitBtn'); const originalText = submitBtn.textContent; submitBtn.disabled = true; submitBtn.textContent = '등록 중...'; try { const formData = { artworkType: document.getElementById('artworkType').value, title: document.getElementById('title').value, author: document.getElementById('author').value, grade: document.getElementById('grade').value + '학년', description: document.getElementById('description').value }; const imageFiles = document.getElementById('imageFile').files; let imageUrls = []; if (imageFiles.length > 0) { const uploadPromises = Array.from(imageFiles).map(file => uploadImageToCloudinary(file)); imageUrls = await Promise.all(uploadPromises); if (imageUrls.some(url => !url)) { throw new Error('일부 이미지 업로드에 실패했습니다.'); } } const newArtwork = { id: Date.now().toString(), ...formData, images: imageUrls, createdAt: new Date().toISOString() }; artworks.unshift(newArtwork); if (!(await saveDataToDB())) { artworks.shift(); throw new Error("DB 저장 실패"); } renderGroupedGallery(); if (isAdminMode) { updateAdminStats(); renderArtworksTable(); } this.reset(); document.getElementById('imagePreviewContainer').innerHTML = ''; document.getElementById('uploadText').style.display = 'block'; showMessage('작품이 성공적으로 등록되었습니다!', 'success'); } catch (error) { console.error('작품 등록 오류:', error); showMessage(`작품 등록에 실패했습니다: ${error.message}`, 'error'); } finally { submitBtn.disabled = false; submitBtn.textContent = originalText; } });
        
        // 이하 모든 다른 함수들은 이전 답변과 동일합니다.
        function showArtworkModal(artwork) { const modal = document.getElementById('modal'); const modalContent = document.getElementById('modalContent'); const isLiked = likedArtworks.has(artwork.id); const likeCount = likes[artwork.id] || 0; const artworkComments = comments[artwork.id] || []; let imageGalleryHtml = ''; if (artwork.images && artwork.images.length > 0) { const mainImage = artwork.images[0]; const thumbnailsHtml = artwork.images.map((imgUrl, index) => `<img src="${imgUrl}" class="modal-thumbnail-img ${index === 0 ? 'active' : ''}" onclick="changeModalImage('${imgUrl}', this)">`).join(''); imageGalleryHtml = `<div class="modal-image-gallery"><img src="${mainImage}" id="modalMainImage" class="modal-main-image" onclick="showFullscreenImage(this.src)">${artwork.images.length > 1 ? `<div class="modal-thumbnails">${thumbnailsHtml}</div>` : ''}</div>`; } else { imageGalleryHtml = '<div style="font-size: 5rem; text-align:center; margin: 20px 0;">🧱</div>'; } let commentsHtml = ''; if (settings.allowComments) { const approvedComments = artworkComments.filter(c => c.approved); const renderReplies = (commentId) => { const parentComment = approvedComments.find(c => c.id === commentId); if (!parentComment || !parentComment.replies || parentComment.replies.length === 0) return ''; return parentComment.replies.map(reply => `<div class="reply"><div class="comment-author">${reply.author}</div><div class="comment-text">${reply.text}</div><div class="comment-date">${new Date(reply.createdAt).toLocaleString()}</div></div>`).join(''); }; const commentsListHtml = approvedComments.map(comment => `<div class="comment"><div class="comment-controls"><button class="btn-warning" onclick="editComment('${artwork.id}', '${comment.id}')">수정</button><button class="btn-danger" onclick="deleteComment('${artwork.id}', '${comment.id}')">삭제</button></div><div class="comment-author">${comment.author} <button class="btn btn-secondary btn-reply" onclick="toggleReplyForm('${comment.id}')">답글</button></div><div class="comment-text">${comment.text}</div><div class="comment-date">${new Date(comment.createdAt).toLocaleString()}</div><div class="replies-container">${renderReplies(comment.id)}</div><div class="reply-form" id="reply-form-for-${comment.id}"><div class="form-group"><input type="text" id="replyAuthor-${comment.id}" placeholder="이름"></div><div class="form-group"><textarea id="replyText-${comment.id}" placeholder="답글 내용..."></textarea></div><button class="btn btn-primary btn-small" onclick="addReply('${artwork.id}', '${comment.id}')">답글 등록</button></div></div>`).join(''); commentsHtml = `<div class="comments-section"><h3>댓글 (${approvedComments.length})</h3><div id="commentsList">${commentsListHtml}</div><div class="comment-form"><h4>댓글 작성</h4><div class="form-group"><input type="text" id="commentAuthor" placeholder="이름을 입력하세요"></div><div class="form-group"><textarea id="commentText" placeholder="댓글을 입력하세요..."></textarea></div><button class="btn btn-primary" onclick="submitComment('${artwork.id}')">댓글 등록</button></div></div>`; } modalContent.innerHTML = `${imageGalleryHtml}<div style="text-align: center;"><h2 style="color: #2c3e50; margin-bottom: 10px;">${artwork.title}</h2><p style="color: #7f8c8d; font-size: 1.1rem; margin-bottom: 20px;">${artwork.author} (${artwork.grade})</p></div><p style="line-height: 1.8; color: #555; font-size: 1.1rem; text-align: center; margin-bottom: 20px;">${artwork.description}</p><div style="text-align: center; margin-bottom: 20px;"><button class="btn btn-primary like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${artwork.id}'); this.classList.toggle('liked'); this.innerHTML='❤️ ' + (likes[artwork.id] || 0);">❤️ ${likeCount} 좋아요</button><button class="btn btn-secondary" onclick="shareArtwork('${artwork.title}')">📤 공유하기</button></div>${commentsHtml}`; modal.style.display = 'block'; document.body.style.overflow = 'hidden'; }
        function changeModalImage(imageUrl, clickedThumbnail) { document.getElementById('modalMainImage').src = imageUrl; document.querySelectorAll('.modal-thumbnail-img').forEach(thumb => thumb.classList.remove('active')); clickedThumbnail.classList.add('active'); }
        function previewImages() { const files = document.getElementById('imageFile').files; const previewContainer = document.getElementById('imagePreviewContainer'); const uploadText = document.getElementById('uploadText'); previewContainer.innerHTML = ''; if (files.length > 0) { uploadText.style.display = 'none'; Array.from(files).forEach(file => { const reader = new FileReader(); reader.onload = e => { const img = document.createElement('img'); img.src = e.target.result; img.className = 'image-preview'; previewContainer.appendChild(img); }; reader.readAsDataURL(file); }); } else { uploadText.style.display = 'block'; } }
        async function toggleLike(artworkId) { if (likedArtworks.has(artworkId)) { likedArtworks.delete(artworkId); likes[artworkId] = Math.max(0, (likes[artworkId] || 1) - 1); } else { likedArtworks.add(artworkId); likes[artworkId] = (likes[artworkId] || 0) + 1; } saveLikedToLocal(); renderGroupedGallery(); await saveDataToDB(); if (isAdminMode) updateAdminStats(); }
        async function addComment(artworkId, authorName, commentText) { if (!settings.allowComments) { showMessage('댓글 기능이 비활성화되어 있습니다.', 'error'); return null; } const newComment = { id: Date.now().toString(), author: authorName, text: commentText, createdAt: new Date().toISOString(), approved: !settings.moderateComments, replies: [] }; if (!comments[artworkId]) { comments[artworkId] = []; } comments[artworkId].push(newComment); if (!(await saveDataToDB())) { comments[artworkId].pop(); return null; } return newComment; }
        function toggleReplyForm(commentId) { const form = document.getElementById(`reply-form-for-${commentId}`); if(form) form.style.display = form.style.display === 'none' ? 'block' : 'none'; }
        async function addReply(artworkId, parentCommentId) { const author = document.getElementById(`replyAuthor-${parentCommentId}`).value.trim(); const text = document.getElementById(`replyText-${parentCommentId}`).value.trim(); if (!author || !text) { showMessage('답글 이름과 내용을 모두 입력해주세요.', 'error'); return; } const parentComment = comments[artworkId]?.find(c => c.id === parentCommentId); if (!parentComment) return; if (!parentComment.replies) parentComment.replies = []; const newReply = { id: Date.now().toString(), author: author, text: text, createdAt: new Date().toISOString(), parentId: parentCommentId }; parentComment.replies.push(newReply); if (await saveDataToDB()) { showMessage('답글이 등록되었습니다.', 'success'); showArtworkModal(artworks.find(a => a.id === artworkId)); } else { parentComment.replies.pop(); showMessage('답글 등록에 실패했습니다.', 'error'); } }
        async function deleteArtwork(artworkId) { if (!confirm('정말로 이 작품을 삭제하시겠습니까?')) return; const originalData = { artworks: [...artworks], comments: JSON.parse(JSON.stringify(comments)), likes: JSON.parse(JSON.stringify(likes)) }; artworks = artworks.filter(artwork => artwork.id !== artworkId); delete comments[artworkId]; delete likes[artworkId]; renderGroupedGallery(); if (!(await saveDataToDB())) { artworks = originalData.artworks; comments = originalData.comments; likes = originalData.likes; renderGroupedGallery(); showMessage('작품 삭제에 실패했습니다.', 'error'); } else { showMessage('작품이 삭제되었습니다.', 'success'); if (isAdminMode) { renderArtworksTable(); updateAdminStats(); } } }
        async function saveArtworkEdit(artworkId) { const artworkIndex = artworks.findIndex(a => a.id === artworkId); if (artworkIndex === -1) return; const originalArtwork = { ...artworks[artworkIndex] }; artworks[artworkIndex].title = document.getElementById('editTitle').value; artworks[artworkIndex].author = document.getElementById('editAuthor').value; artworks[artworkIndex].grade = document.getElementById('editGrade').value; artworks[artworkIndex].description = document.getElementById('editDescription').value; artworks[artworkIndex].artworkType = document.getElementById('editArtworkType').value; if (await saveDataToDB()) { closeModal(); renderGroupedGallery(); renderArtworksTable(); showMessage('작품이 수정되었습니다.', 'success'); } else { artworks[artworkIndex] = originalArtwork; showMessage('작품 수정에 실패했습니다.', 'error'); } }
        async function editComment(artworkId, commentId) { const comment = comments[artworkId]?.find(c => c.id === commentId); if (!comment) return; const newText = prompt('댓글을 수정하세요:', comment.text); if (newText !== null && newText.trim() !== '') { const originalText = comment.text; comment.text = newText.trim(); comment.editedAt = new Date().toISOString(); if (await saveDataToDB()) { renderCommentsTable(); if(document.getElementById('modal').style.display === 'block') { showArtworkModal(artworks.find(a => a.id === artworkId)); } showMessage('댓글이 수정되었습니다.', 'success'); } else { comment.text = originalText; showMessage('댓글 수정에 실패했습니다.', 'error'); } } }
        async function deleteComment(artworkId, commentId) { if (!confirm('정말로 이 댓글을 삭제하시겠습니까? 답글도 모두 삭제됩니다.')) return; if (comments[artworkId]) { const originalComments = JSON.parse(JSON.stringify(comments)); comments[artworkId] = comments[artworkId].filter(c => c.id !== commentId); if (comments[artworkId].length === 0) delete comments[artworkId]; if (await saveDataToDB()) { renderCommentsTable(); updateAdminStats(); if(document.getElementById('modal').style.display === 'block') { showArtworkModal(artworks.find(a => a.id === artworkId)); } showMessage('댓글이 삭제되었습니다.', 'success'); } else { comments = originalComments; showMessage('댓글 삭제에 실패했습니다.', 'error'); } } }
        async function resetAllData() { if (!confirm('정말로 모든 데이터를 초기화하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) return; const confirmText = prompt('확인을 위해 "초기화"를 입력하세요:'); if (confirmText !== '초기화') return; const backupArtworks = [...artworks]; artworks = []; comments = {}; likes = {}; settings = defaultSettings; if (await saveDataToDB()) { showMessage('모든 데이터가 초기화되었습니다.', 'success'); location.reload(); } else { artworks = backupArtworks; showMessage('초기화에 실패했습니다.', 'error'); } }
        async function updateArtworkOrder() { const originalArtworks = [...artworks]; const tableBody = document.getElementById('artworksTableBody'); const newOrderedIds = [...tableBody.querySelectorAll('tr')].map(row => row.dataset.id); artworks = newOrderedIds.map(id => artworks.find(a => a.id === id)).filter(Boolean); if (await saveDataToDB()) { renderGroupedGallery(); showMessage('작품 순서가 저장되었습니다.', 'success'); } else { artworks = originalArtworks; renderArtworksTable(); showMessage('순서 저장에 실패했습니다.', 'error'); } }
        function toggleUploadPanel() { const panel = document.getElementById('uploadPanel'); const adminPanel = document.getElementById('adminPanel'); const statusSection = document.getElementById('statusSection'); if (panel.classList.contains('active')) { panel.classList.remove('active'); document.querySelector('.header-btn').classList.remove('active'); return; } const openPanel = () => { panel.classList.add('active'); adminPanel.classList.remove('active'); statusSection.classList.remove('active'); document.querySelector('.header-btn').classList.add('active'); document.querySelectorAll('.header-btn')[1].classList.remove('active'); }; if (settings.requireUploadPassword) { const password = prompt('작품을 등록하려면 비밀번호를 입력하세요:'); if (password === settings.uploadPassword) { openPanel(); } else if (password !== null) { showMessage('비밀번호가 틀렸습니다.', 'error'); } } else { openPanel(); } }
        async function saveSettings() { const saveBtn = event.target; saveBtn.disabled = true; saveBtn.textContent = '저장 중...'; const originalSettings = JSON.parse(JSON.stringify(settings)); try { const headerImageFile = document.getElementById('headerImageFile').files[0]; if (headerImageFile) { const imageUrl = await uploadImageToCloudinary(headerImageFile); if (imageUrl) settings.headerImage = imageUrl; else throw new Error("헤더 이미지 업로드 실패"); } settings.title = document.getElementById('siteTitle').value; settings.description = document.getElementById('siteDescription').value; settings.allowComments = document.getElementById('allowComments').checked; settings.moderateComments = document.getElementById('moderateComments').checked; const newPassword = document.getElementById('adminPassword').value; if (newPassword.trim() !== '') settings.adminPassword = newPassword; settings.requireUploadPassword = document.getElementById('requireUploadPassword').checked; const newUploadPassword = document.getElementById('uploadPassword').value; if (newUploadPassword.trim() !== '') { settings.uploadPassword = newUploadPassword; } settings.gradeDescriptions['all'].title = document.getElementById('gradeTitleAll').value; settings.gradeDescriptions['all'].description = document.getElementById('gradeDescAll').value; for(let i = 1; i <= 6; i++) { settings.gradeDescriptions[`${i}학년`].title = document.getElementById(`gradeTitle${i}`).value; settings.gradeDescriptions[`${i}학년`].description = document.getElementById(`gradeDesc${i}`).value; } if (!(await saveDataToDB())) throw new Error("DB 저장 실패"); applyHeaderSettings(); loadSettingsForm(); showMessage('설정이 저장되었습니다.', 'success'); updateGradeInfo(document.querySelector('.filter-btn.active').dataset.category); } catch(error) { settings = originalSettings; showMessage(error.message, 'error'); } finally { saveBtn.disabled = false; saveBtn.textContent = '설정 저장'; } }
        function loadSettingsForm() { document.getElementById('siteTitle').value = settings.title; document.getElementById('siteDescription').value = settings.description; document.getElementById('allowComments').checked = settings.allowComments; document.getElementById('moderateComments').checked = settings.moderateComments; const headerPreview = document.getElementById('headerImagePreview'); const headerUploadText = document.getElementById('headerUploadText'); if (settings.headerImage) { headerPreview.src = settings.headerImage; headerPreview.style.display = 'block'; headerUploadText.style.display = 'none'; } else { headerPreview.style.display = 'none'; headerUploadText.style.display = 'block'; } document.getElementById('requireUploadPassword').checked = settings.requireUploadPassword; document.getElementById('uploadPassword').value = ''; for(let i = 1; i <= 6; i++) { const gradeKey = `${i}학년`; if (settings.gradeDescriptions[gradeKey]) { document.getElementById(`gradeTitle${i}`).value = settings.gradeDescriptions[gradeKey].title; document.getElementById(`gradeDesc${i}`).value = settings.gradeDescriptions[gradeKey].description; } } if (settings.gradeDescriptions['all']) { document.getElementById('gradeTitleAll').value = settings.gradeDescriptions['all'].title; document.getElementById('gradeDescAll').value = settings.gradeDescriptions['all'].description; } }
        function toggleAdminPanel() { const panel = document.getElementById('adminPanel'); const uploadPanel = document.getElementById('uploadPanel'); const statusSection = document.getElementById('statusSection'); if (!panel.classList.contains('active')) { const password = prompt('관리자 비밀번호를 입력하세요:'); if (password === settings.adminPassword) { panel.classList.add('active'); statusSection.classList.add('active'); uploadPanel.classList.remove('active'); document.querySelectorAll('.header-btn')[1].classList.add('active'); document.querySelector('.header-btn').classList.remove('active'); isAdminMode = true; document.body.classList.add('admin-mode'); updateAdminStats(); renderAdminTables(); loadSettingsForm(); showMessage('관리자 모드가 활성화되었습니다!', 'success'); } else if (password !== null) { showMessage('비밀번호가 틀렸습니다.', 'error'); } } else { panel.classList.remove('active'); statusSection.classList.remove('active'); document.querySelectorAll('.header-btn')[1].classList.remove('active'); isAdminMode = false; document.body.classList.remove('admin-mode'); showMessage('관리자 모드가 비활성화되었습니다.', 'success'); } }
        function switchAdminTab(tab) { document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); document.getElementById(tab + 'Content').classList.add('active'); if (tab === 'artworks') renderArtworksTable(); else if (tab === 'comments') renderCommentsTable(); else if (tab === 'users') renderUsersTable(); }
        function updateAdminStats() { const totalArtworks = artworks.length; const totalComments = Object.values(comments).reduce((sum, artworkComments) => sum + artworkComments.length, 0); const totalLikes = Object.values(likes).reduce((sum, count) => sum + count, 0); const today = new Date().toDateString(); const todayArtworks = artworks.filter(artwork => new Date(artwork.createdAt).toDateString() === today).length; document.getElementById('statArtworks').textContent = totalArtworks; document.getElementById('statComments').textContent = totalComments; document.getElementById('statLikes').textContent = totalLikes; document.getElementById('statToday').textContent = todayArtworks; document.getElementById('totalCount').textContent = totalArtworks; document.getElementById('totalComments').textContent = totalComments; }
        function renderArtworksTable() { const tbody = document.getElementById('artworksTableBody'); tbody.innerHTML = ''; artworks.forEach(artwork => { const row = document.createElement('tr'); row.setAttribute('draggable', true); row.setAttribute('data-id', artwork.id); const artworkComments = comments[artwork.id] || []; const artworkLikes = likes[artwork.id] || 0; row.innerHTML = `<td><input type="checkbox" class="artwork-checkbox" data-id="${artwork.id}"></td><td>${artwork.title}</td><td>${artwork.author}</td><td>${artwork.grade}</td><td>${artworkLikes}</td><td>${artworkComments.length}</td><td>${new Date(artwork.createdAt).toLocaleDateString()}</td><td><button class="btn btn-warning btn-small" onclick="editArtwork('${artwork.id}')">수정</button><button class="btn btn-danger btn-small" onclick="deleteArtwork('${artwork.id}')">삭제</button></td>`; tbody.appendChild(row); }); }
        function renderCommentsTable() { const tbody = document.getElementById('commentsTableBody'); tbody.innerHTML = ''; Object.entries(comments).forEach(([artworkId, artworkComments]) => { const artwork = artworks.find(a => a.id === artworkId); artworkComments.forEach(comment => { const row = document.createElement('tr'); row.innerHTML = `<td><input type="checkbox" class="comment-checkbox" data-id="${comment.id}"></td><td>${artwork ? artwork.title : '삭제된 작품'}</td><td>${comment.author}</td><td>${comment.text.substring(0, 50)}${comment.text.length > 50 ? '...' : ''}</td><td>${new Date(comment.createdAt).toLocaleDateString()}</td><td><button class="btn btn-warning btn-small" onclick="editComment('${artwork.id}', '${comment.id}')">수정</button><button class="btn btn-danger btn-small" onclick="deleteComment('${artwork.id}', '${comment.id}')">삭제</button></td>`; tbody.appendChild(row); }); }); }
        function renderUsersTable() { const tbody = document.getElementById('usersTableBody'); tbody.innerHTML = ''; const users = {}; artworks.forEach(artwork => { if (!users[artwork.author]) { users[artwork.author] = { name: artwork.author, grade: artwork.grade, artworks: 0, comments: 0, likes: 0, lastActivity: artwork.createdAt }; } users[artwork.author].artworks++; users[artwork.author].likes += likes[artwork.id] || 0; if (new Date(artwork.createdAt) > new Date(users[artwork.author].lastActivity)) { users[artwork.author].lastActivity = artwork.createdAt; } }); Object.values(comments).forEach(artworkComments => { artworkComments.forEach(comment => { if (!users[comment.author]) { users[comment.author] = { name: comment.author, grade: '미확인', artworks: 0, comments: 0, likes: 0, lastActivity: comment.createdAt }; } users[comment.author].comments++; if (new Date(comment.createdAt) > new Date(users[comment.author].lastActivity)) { users[comment.author].lastActivity = comment.createdAt; } }); }); Object.values(users).forEach(user => { const row = document.createElement('tr'); row.innerHTML = `<td>${user.name}</td><td>${user.grade}</td><td>${user.artworks}</td><td>${user.comments}</td><td>${user.likes}</td><td>${new Date(user.lastActivity).toLocaleDateString()}</td>`; tbody.appendChild(row); }); }
        async function submitComment(artworkId) { const author = document.getElementById('commentAuthor').value.trim(); const text = document.getElementById('commentText').value.trim(); if (!author || !text) { showMessage('이름과 댓글을 모두 입력해주세요.', 'error'); return; } const newComment = await addComment(artworkId, author, text); if (newComment) { document.getElementById('commentAuthor').value = ''; document.getElementById('commentText').value = ''; if (settings.moderateComments) { showMessage('댓글이 등록되었습니다. 관리자 승인 후 표시됩니다.', 'success'); } else { showMessage('댓글이 등록되었습니다.', 'success'); showArtworkModal(artworks.find(a => a.id === artworkId)); } renderGroupedGallery(); if (isAdminMode) { updateAdminStats(); renderCommentsTable(); } } }
        function showMessage(text, type = 'success') { const existing = document.querySelector('.message'); if (existing) existing.remove(); const message = document.createElement('div'); message.className = `message ${type}`; message.textContent = text; document.querySelector('header').appendChild(message); setTimeout(() => message.remove(), 5000); }
        async function uploadImageToCloudinary(file) { if (!file) return null; try { const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData }); if (!response.ok) throw new Error('Cloudinary 이미지 업로드 실패'); const result = await response.json(); return result.secure_url; } catch (error) { console.error('이미지 업로드 오류:', error); return null; } }
        function editArtwork(artworkId) { const artwork = artworks.find(a => a.id === artworkId); if (!artwork) return; const modal = document.getElementById('modal'); const modalContent = document.getElementById('modalContent'); modalContent.innerHTML = `<h2>작품 수정</h2><div class="edit-form"><div class="form-group"><label>제목</label><input type="text" id="editTitle" value="${artwork.title}"></div><div class="form-group"><label>이름(모둠)</label><input type="text" id="editAuthor" value="${artwork.author}"></div><div class="form-group"><label>학년</label><select id="editGrade"><option value="1학년" ${artwork.grade === '1학년' ? 'selected' : ''}>1학년</option><option value="2학년" ${artwork.grade === '2학년' ? 'selected' : ''}>2학년</option><option value="3학년" ${artwork.grade === '3학년' ? 'selected' : ''}>3학년</option><option value="4학년" ${artwork.grade === '4학년' ? 'selected' : ''}>4학년</option><option value="5학년" ${artwork.grade === '5학년' ? 'selected' : ''}>5학년</option><option value="6학년" ${artwork.grade === '6학년' ? 'selected' : ''}>6학년</option></select></div><div class="form-group"><label>설명</label><textarea id="editDescription">${artwork.description}</textarea></div><div class="form-group"><label>유형</label><select id="editArtworkType"><option value="사진" ${artwork.artworkType === '사진' ? 'selected' : ''}>사진</option><option value="결과물" ${artwork.artworkType === '결과물' ? 'selected' : ''}>결과물</option><option value="학습지(활동지)" ${artwork.artworkType === '학습지(활동지)' ? 'selected' : ''}>학습지(활동지)</option></select></div><div style="text-align: center; margin-top: 20px;"><button class="btn btn-primary" onclick="saveArtworkEdit('${artwork.id}')">저장</button><button class="btn btn-secondary" onclick="closeModal()">취소</button></div></div>`; modal.style.display = 'block'; document.body.style.overflow = 'hidden'; }
        async function bulkDelete() { const selected = document.querySelectorAll('.artwork-checkbox:checked'); if (selected.length === 0) return showMessage('삭제할 작품을 선택하세요.', 'error'); if (!confirm(`선택한 ${selected.length}개의 작품을 삭제하시겠습니까?`)) return; const idsToDelete = [...selected].map(cb => cb.dataset.id); artworks = artworks.filter(artwork => !idsToDelete.includes(artwork.id)); idsToDelete.forEach(id => { delete comments[id]; delete likes[id]; }); if (await saveDataToDB()) { showMessage(`${selected.length}개의 작품이 삭제되었습니다.`, 'success'); renderGroupedGallery(); renderArtworksTable(); updateAdminStats(); } else { loadDataFromDB().then(() => { renderGroupedGallery(); renderArtworksTable(); }); } }
        async function bulkDeleteComments() { const selected = document.querySelectorAll('.comment-checkbox:checked'); if (selected.length === 0) return showMessage('삭제할 댓글을 선택하세요.', 'error'); if (!confirm(`선택한 ${selected.length}개의 댓글을 삭제하시겠습니까?`)) return; const idsToDelete = new Set([...selected].map(cb => cb.dataset.id)); Object.keys(comments).forEach(artId => { comments[artId] = comments[artId].filter(c => !idsToDelete.has(c.id)); if (comments[artId].length === 0) delete comments[artId]; }); if (await saveDataToDB()) { showMessage(`${idsToDelete.size}개의 댓글이 삭제되었습니다.`, 'success'); renderCommentsTable(); renderGroupedGallery(); updateAdminStats(); } else { loadDataFromDB().then(() => { renderCommentsTable(); renderGroupedGallery(); }); } }
        function removeHeaderImage() { if (confirm("헤더 이미지를 제거하시겠습니까? '설정 저장' 버튼을 눌러야 최종 반영됩니다.")) { settings.headerImage = ''; document.getElementById('headerImageFile').value = ''; loadSettingsForm(); } }
        function exportData() { const data = { artworks, comments, likes, settings, exportDate: new Date().toISOString() }; const dataStr = JSON.stringify(data, null, 2); const dataBlob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `brick_gallery_backup_${new Date().toISOString().split('T')[0]}.json`; link.click(); URL.revokeObjectURL(url); showMessage('데이터가 JSON 파일로 내보내기되었습니다.', 'success'); }
        function previewHeaderImage() { const file = document.getElementById('headerImageFile').files[0]; const preview = document.getElementById('headerImagePreview'); const uploadText = document.getElementById('headerUploadText'); if (file) { const reader = new FileReader(); reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; uploadText.style.display = 'none'; }; reader.readAsDataURL(file); } }
        function closeModal() { document.getElementById('modal').style.display = 'none'; document.body.style.overflow = 'auto'; }
        function showFullscreenImage(imageUrl) { if (!imageUrl) return; const overlay = document.getElementById('fullscreenOverlay'); const image = document.getElementById('fullscreenImage'); image.src = imageUrl; overlay.classList.add('show'); document.body.style.overflow = 'hidden'; }
        function closeFullscreenImage() { const overlay = document.getElementById('fullscreenOverlay'); overlay.classList.remove('show'); if (document.getElementById('modal').style.display === 'none') { document.body.style.overflow = 'auto'; } }
        function shareArtwork(title) { if (navigator.share) { navigator.share({ title: `${title} - ${settings.title}`, text: `멋진 브릭모델 작품을 확인해보세요!`, url: window.location.href }); } else { navigator.clipboard.writeText(window.location.href).then(() => showMessage('링크가 클립보드에 복사되었습니다!', 'success')).catch(() => showMessage('링크 복사에 실패했습니다.', 'error')); } }
        function updateGradeInfo(category) { const gradeInfoSection = document.getElementById('gradeInfoSection'); const gradeInfoTitle = document.getElementById('gradeInfoTitle'); const gradeInfoDescription = document.getElementById('gradeInfoDescription'); const info = settings.gradeDescriptions[category] || settings.gradeDescriptions['all']; gradeInfoTitle.textContent = info.title; gradeInfoDescription.textContent = info.description; updateGradeStats(category); gradeInfoSection.classList.add('active'); }
        function updateGradeStats(category) { const gradeInfoSection = document.getElementById('gradeInfoSection'); let statsHtml = ''; if (category === 'all') { const totalArtworks = artworks.length; const totalLikes = Object.values(likes).reduce((sum, count) => sum + count, 0); const totalComments = Object.values(comments).reduce((sum, arr) => sum + arr.length, 0); statsHtml = `<div class="grade-stats"><div class="grade-stat"><div class="grade-stat-number">${totalArtworks}</div><div class="grade-stat-label">전체 작품</div></div><div class="grade-stat"><div class="grade-stat-number">${totalLikes}</div><div class="grade-stat-label">총 좋아요</div></div><div class="grade-stat"><div class="grade-stat-number">${totalComments}</div><div class="grade-stat-label">총 댓글</div></div></div>`; } else { const gradeArtworks = artworks.filter(artwork => artwork.grade === category); const gradeLikes = gradeArtworks.reduce((sum, artwork) => sum + (likes[artwork.id] || 0), 0); const gradeComments = gradeArtworks.reduce((sum, artwork) => sum + (comments[artwork.id] || []).length, 0); statsHtml = `<div class="grade-stats"><div class="grade-stat"><div class="grade-stat-number">${gradeArtworks.length}</div><div class="grade-stat-label">작품 수</div></div><div class="grade-stat"><div class="grade-stat-number">${gradeLikes}</div><div class="grade-stat-label">좋아요</div></div><div class="grade-stat"><div class="grade-stat-number">${gradeComments}</div><div class="grade-stat-label">댓글</div></div></div>`; } const existingStats = gradeInfoSection.querySelector('.grade-stats'); if (existingStats) existingStats.remove(); gradeInfoSection.querySelector('.grade-info-content').insertAdjacentHTML('beforeend', statsHtml); }
        document.getElementById('selectAll').addEventListener('change', function() { document.querySelectorAll('.artwork-checkbox').forEach(c => c.checked = this.checked); });
        document.getElementById('selectAllComments').addEventListener('change', function() { document.querySelectorAll('.comment-checkbox').forEach(c => c.checked = this.checked); });
        function applyHeaderSettings() { const headerImageElem = document.getElementById('headerImage'); const headerTitleElem = document.getElementById('headerTitleText'); headerTitleElem.textContent = settings.title; document.title = settings.title; document.querySelector('.subtitle').textContent = settings.description; if (settings.headerImage && settings.headerImage.trim() !== '') { headerImageElem.src = settings.headerImage; headerImageElem.style.display = 'inline-block'; } else { headerImageElem.style.display = 'none'; } }
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeModal(); closeFullscreenImage(); } if (e.ctrlKey && e.key === 'k') { e.preventDefault(); document.getElementById('searchInput').focus(); } if (e.ctrlKey && e.key === 'u') { e.preventDefault(); toggleUploadPanel(); } if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); toggleAdminPanel(); } });
        document.getElementById('modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
        window.addEventListener('online', () => showMessage('✅ 인터넷 연결이 복구되었습니다.', 'success'));
        window.addEventListener('offline', () => showMessage('⚠️ 인터넷 연결이 끊어졌습니다. 일부 기능이 제한될 수 있습니다.', 'error'));
        function setupDragAndDrop() { const tableBody = document.getElementById('artworksTableBody'); let draggedItem = null; tableBody.addEventListener('dragstart', e => { draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); }); tableBody.addEventListener('dragend', e => { e.target.classList.remove('dragging'); draggedItem = null; }); tableBody.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElement(tableBody, e.clientY); const currentlyDragged = document.querySelector('.dragging'); if (afterElement == null) { tableBody.appendChild(currentlyDragged); } else { tableBody.insertBefore(currentlyDragged, afterElement); } }); tableBody.addEventListener('drop', e => { e.preventDefault(); updateArtworkOrder(); }); function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element; } }
    </script>
</body>
</html>
